#!/bin/sh -exu

export LC_COLLATE=en_US.UTF-8
export LANG=en_US.UTF-8

rm -rf lib; mkdir -p lib
git submodule sync
git submodule init
git submodule update

if find $HOME/.cabal/packages/hackage.haskell.org/00-index.cache -type f -mtime +1 | grep -q 00-index; then
    cabal update
fi

# test everything

MODULES=aeson

for x in $MODULES; do
  (cd orphanarium-$x && make test) || exit $?
done

# build everything

for x in $MODULES; do
  (cd orphanarium-$x && make build) || exit $?
done
